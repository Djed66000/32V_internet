<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Pico 2W - v2.0.4 (Multi-Mode)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mqtt/4.3.7/mqtt.min.js"></script>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --orange: #e67e22; --accent: #27ae60; }
        body { font-family: sans-serif; background: var(--bg); color: white; margin: 0; padding: 10px; }
        .controls { position: sticky; top: 0; background: var(--bg); padding: 15px; z-index: 100; border-bottom: 2px solid var(--orange); }
        .mode-selector { display: flex; gap: 10px; margin-bottom: 15px; background: #333; padding: 5px; border-radius: 8px; }
        .mode-btn { flex: 1; padding: 8px; border: none; border-radius: 5px; background: #444; color: white; cursor: pointer; }
        .mode-active { background: var(--orange); font-weight: bold; }
        .btn-group { display: flex; flex-wrap: wrap; gap: 8px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; }
        .btn-pct { background: var(--orange); }
        .btn-send { background: var(--accent); width: 100%; margin-top: 15px; font-size: 1.1em; }
        .grid-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); gap: 10px; margin-top: 15px; }
        .slider-card { background: var(--card); padding: 10px; border-radius: 8px; text-align: center; border: 1px solid #333; }
        input[type=range] { width: 100%; height: 100px; appearance: slider-vertical; }
        .version { font-size: 0.7em; color: #666; text-align: right; margin-top: 5px; }
    </style>
</head>
<body>

<div class="controls">
    <div class="mode-selector">
        <button id="mode255" class="mode-btn mode-active" onclick="changeMode(255)">MODE 255 (8-bit)</button>
        <button id="mode1000" class="mode-btn" onclick="changeMode(1000)">MODE 1000 (10-bit)</button>
    </div>

    <div class="btn-group">
        <button class="btn-pct" onclick="setAll(0)">0%</button>
        <button class="btn-pct" id="btn25" onclick="setAll(0.25)">25%</button>
        <button class="btn-pct" id="btn50" onclick="setAll(0.5)">50%</button>
        <button class="btn-pct" id="btn75" onclick="setAll(0.75)">75%</button>
        <button class="btn-pct" id="btn100" onclick="setAll(1)">100%</button>
    </div>
    
    <button class="btn-send" onclick="sendData()">ENVOYER TRAME RS485</button>
    <div class="version">v2.0.4 | Ping: <span id="pingLed">‚óè</span></div>
</div>

<div id="sliderGrid" class="grid-container"></div>

<script>
    let currentMax = 255;
    let values = new Array(32).fill(0);
    const TOPIC_CMD = 'p32h/remote/99/cmd';

    function changeMode(m) {
        currentMax = m;
        document.getElementById('mode255').className = m === 255 ? 'mode-btn mode-active' : 'mode-btn';
        document.getElementById('mode1000').className = m === 1000 ? 'mode-btn mode-active' : 'mode-btn';
        renderSliders();
    }

    function renderSliders() {
        const grid = document.getElementById('sliderGrid');
        grid.innerHTML = '';
        for (let i = 0; i < 32; i++) {
            values[i] = 0;
            grid.innerHTML += `
                <div class="slider-card">
                    <small>CH ${i+1}</small><br>
                    <input type="range" min="0" max="${currentMax}" value="0" oninput="updateVal(${i}, this.value)">
                    <div id="v${i}" style="color:var(--orange)">0</div>
                </div>`;
        }
    }

    function updateVal(i, v) { 
        values[i] = parseInt(v); 
        document.getElementById(`v${i}`).innerText = v; 
    }

    function setAll(ratio) {
        const val = Math.round(ratio * currentMax);
        const sliders = document.querySelectorAll('input[type=range]');
        for(let i=0; i<32; i++) {
            values[i] = val;
            sliders[i].value = val;
            document.getElementById(`v${i}`).innerText = val;
        }
    }

    const client = mqtt.connect('wss://broker.hivemq.com:8884/mqtt');
    
    function sendData() {
        // On envoie le max actuel suivi des 32 valeurs pour que le Pico sache quoi faire
        const payload = currentMax + ":" + values.join(',');
        client.publish(TOPIC_CMD, payload);
    }

    renderSliders();
</script>
</body>
</html>
